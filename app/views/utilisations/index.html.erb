<div>
    <h2>Afficher les utilisations</h2>
    
    <%= form_with(url: utilisations_path, method: :get, data: {turbo_frame: "utilisations", turbo_action: "advance"}) do |form| %>
    <div>
        <%= form.label :start_date, "Depuis"  %>
        <%= form.date_field :start_date, value: if params[:start_date].present? then params[:start_date] end %>
    </div>
    <div>
        <%= form.label :end_date, "jusqu'à"  %>
        <%= form.date_field :end_date, value: if params[:end_date].present? then params[:end_date] end %>
    </div>
    <div>
        <%= form.label :tout, "Afficher toutes les utilisations"  %>
        <%= form.check_box :tout, checked: params[:tout] == "1"  %>
    </div>
    <div>
        <%= form.label :tri, "Trier par"  %>
        <%= form.select :tri, ["date d'utilisation","ressource","chantier","date de creation"], selected: if params[:tri].present? then params[:tri] end %>
    </div>
    <div>
        <%= form.submit 'Afficher' %> | <%= form.submit 'Imprimer' %>
    </div>
    <% end %>
</div>


<h1>Utilisations</h1>

<%= render "utilisations", utilisations: @utilisations %>

<h2>Ressources</h2>

<table id="ressources_utilisations"  class="styled-table">
    <tr>
        <th>Ressource</th>
        <th>Quantité utilisée sur cette recherche</th>
    </tr>
    <% @utilisations.map{|u| u.ressource}.uniq.each do |ressource| %>
        <tr>
            <td><%= ressource.nom_complet %></td>
            <td><%=  @utilisations.where(ressource: ressource).sum{|u| u.quantite} %></td>
        </tr>
    <% end %>
</table>

<h2>Utilisations par chantier</h2>

<% @utilisations.map{|u| u.chantier}.uniq.each do |chantier| %>
    <h3><%= chantier.nom_complet %></h3>
    <%= render "utilisations/utilisations_virtuelles", utilisations_virtuelles: chantier.utilisations_virtuelles %>
<% end %>
